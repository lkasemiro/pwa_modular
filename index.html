<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Supervisão Ambiental – PWA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>

  <!-- CSS extra -->
  <link rel="stylesheet" href="style.css" />

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Mensagens -->
  <div id="message-box"
       class="fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-lg text-white text-sm hidden z-50">
  </div>

  <!-- Spinner -->
  <div id="loading-spinner"
       class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-40">
    <div class="bg-white px-6 py-4 rounded-xl shadow-lg flex items-center space-x-3">
      <div class="w-6 h-6 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
      <span class="text-gray-700">Carregando...</span>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <header class="mb-6 flex items-center justify-between">
      <div>
        <h1 class="text-xl sm:text-2xl font-bold text-cedae-blue">
          Supervisão Ambiental – PWA
        </h1>
        <p class="text-sm text-gray-600">
          Registro de visitas e formulários técnicos
        </p>
      </div>
    </header>

    <!-- ========================= -->
    <!-- TELA 1 – CADASTRO         -->
    <!-- ========================= -->
    <section id="screen-cadastro" class="screen">
      <div class="bg-white shadow rounded-xl p-6 sm:p-8">
        <h2 class="text-lg sm:text-xl font-semibold text-cedae-blue mb-4">
          Cadastro da visita
        </h2>

        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Avaliador
            </label>
            <input id="avaliador" type="text"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Colaborador
            </label>
            <input id="colaborador" type="text"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Data da visita
            </label>
            <input id="data_visita" type="date"
                   class="w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan" />
          </div>
        </div>

        <div class="mt-6 flex justify-end">
          <button id="btn-cadastro-continuar"
                  class="btn-primary">
            Avançar
          </button>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- TELA 2 – LOCAL DA VISITA  -->
    <!-- ========================= -->
    <section id="screen-local" class="screen hidden">
      <div class="bg-white shadow rounded-xl p-6 sm:p-8">
        <h2 class="text-lg sm:text-xl font-semibold text-cedae-blue mb-2">
          Selecione o local da visita
        </h2>
        <p class="text-sm text-gray-600 mb-4">
          Escolha a unidade onde a visita está sendo realizada.
        </p>

        <div id="lista_locais" class="flex flex-wrap -m-2">
          <!-- cards via JS -->
        </div>

        <div class="mt-6 flex justify-between">
          <button type="button"
                  onclick="goTo('cadastro')"
                  class="btn-neutral">
            Voltar
          </button>
          <button id="btn-local-continuar"
                  class="btn-primary disabled:opacity-40 disabled:cursor-not-allowed"
                  disabled>
            Avançar
          </button>
        </div>
      </div>
    </section>

    <!-- =============================== -->
    <!-- TELA 3 – SELEÇÃO DO FORMULÁRIO  -->
    <!-- =============================== -->
    <section id="screen-form-select" class="screen hidden">
      <div class="bg-white shadow rounded-xl p-6 sm:p-8">
        <h2 class="text-lg sm:text-xl font-semibold text-cedae-blue mb-2">
          Selecione o formulário
        </h2>
        <p class="text-sm text-gray-600 mb-4">
          Escolha qual formulário deseja preencher para este local.
        </p>

        <div id="lista_formularios" class="flex flex-wrap -m-2">
          <!-- cards via JS -->
        </div>

        <div class="mt-6 flex justify-between">
          <button type="button"
                  onclick="goTo('local')"
                  class="btn-neutral">
            Voltar
          </button>
          <button id="btn-form-select-continuar"
                  class="btn-primary disabled:opacity-40 disabled:cursor-not-allowed"
                  disabled>
            Avançar
          </button>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- TELA 4 – FORMULÁRIO       -->
    <!-- ========================= -->
    <section id="screen-formulario" class="screen hidden">
      <div class="bg-white shadow rounded-xl p-4 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4 text-xs sm:text-sm text-gray-600">
          <div>
            <div><strong>Avaliador:</strong> <span id="info_avaliador"></span></div>
            <div><strong>Local da Visita:</strong> <span id="info_local_visita"></span></div>
            <div><strong>Data:</strong> <span id="info_data_visita"></span></div>
            <div><strong>Formulário:</strong> <span id="roteiro-atual-label"></span></div>
          </div>
        </div>

        <div class="flex flex-wrap gap-4 mb-4">
          <div id="local_pge_box" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Local (PGE)
            </label>
            <select id="local_pge_select"
                    class="w-48 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan">
            </select>
          </div>

          <div id="sublocal_box" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Sublocal
            </label>
            <select id="sublocal_select"
                    class="w-48 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan">
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Seção
            </label>
            <select id="secao_select"
                    class="w-48 border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-cedae-cyan">
            </select>
          </div>
        </div>

        <div id="conteudo_formulario" class="mt-2">
          <!-- perguntas via JS -->
        </div>

        <div class="mt-6 flex justify-between">
          <button type="button"
                  onclick="goTo('form-select')"
                  class="btn-neutral">
            Voltar
          </button>
          <button type="button"
                  onclick="goTo('final')"
                  class="btn-primary">
            Avançar
          </button>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- TELA 5 – CÂMERA           -->
    <!-- ========================= -->
    <section id="screen-camera" class="screen hidden">
      <div class="bg-white shadow rounded-xl p-4 sm:p-6">
        <h2 class="text-lg sm:text-xl font-semibold text-cedae-blue mb-2">
          Câmera
        </h2>
        <p class="text-sm text-gray-600 mb-3">
          Aponte a câmera para o alvo e capture a foto. Ela será associada à pergunta selecionada.
        </p>

        <div class="relative bg-black rounded-lg overflow-hidden mb-3 h-60 flex items-center justify-center">
          <video id="video" autoplay playsinline class="hidden w-full h-full object-cover"></video>
          <div id="camera-placeholder" class="text-white text-sm text-center px-4">
            Câmera não iniciada
          </div>
        </div>

        <canvas id="canvas" class="hidden"></canvas>

        <div class="flex justify-between items-center mt-2">
          <button id="btn-camera-toggle"
                  class="btn-primary text-xs sm:text-sm">
            Iniciar Câmera
          </button>
          <div class="space-x-2">
            <button id="btn-camera-capture"
                    class="bg-green-600 hover:bg-green-700 text-white text-xs sm:text-sm px-3 py-2 rounded-lg"
                    disabled>
              Capturar
            </button>
            <button id="btn-camera-voltar"
                    class="btn-neutral text-xs sm:text-sm">
              Voltar ao formulário
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- TELA 6 – FINALIZAÇÃO      -->
    <!-- ========================= -->
    <section id="screen-final" class="screen hidden">
      <div class="bg-white shadow rounded-xl p-6 sm:p-8">
        <h2 class="text-lg sm:text-xl font-semibold text-cedae-blue mb-2">
          Finalização da visita
        </h2>
        <p class="text-sm text-gray-600 mb-4">
          As respostas são salvas automaticamente. Aqui você pode baixar os dados e concluir a visita.
        </p>

        <h3 class="text-sm font-semibold text-gray-700 mb-2">
          Exportação de dados (formulário atual)
        </h3>
        <div class="flex flex-wrap -m-2 mb-4">
          <div class="w-full sm:w-1/2 lg:w-1/3 p-2">
            <button id="btn-exportar-csv-atual"
                    class="card-button">
              Baixar CSV do formulário atual
            </button>
          </div>
          <div class="w-full sm:w-1/2 lg:w-1/3 p-2">
            <button id="btn-exportar-fotos-atual"
                    class="card-button">
              Baixar ZIP de fotos do formulário atual
            </button>
          </div>
        </div>

        <div class="mt-6 p-4 border border-red-200 rounded-lg bg-red-50 text-sm text-red-800">
          <p class="font-semibold mb-1">Concluir visita</p>
          <p class="mb-2">
            Ao concluir, você será redirecionado para a seleção de local, mantendo avaliador, colaborador e data.
            As respostas e fotos desta visita serão arquivadas.
          </p>
          <button id="btn-recomecar"
                  class="bg-red-600 hover:bg-red-700 text-white font-semibold px-5 py-2 rounded-lg text-sm">
            Concluir visita
          </button>
        </div>

        <div class="mt-4 flex justify-start">
          <button type="button"
                  onclick="goTo('formulario')"
                  class="btn-neutral">
            Voltar ao formulário
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="roteiros.js"></script>
  <script src="indexedDB.js"></script>
  <script src="app.js"></script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch(err => console.error("Erro ao registrar SW:", err));
      });
    }
  </script>
</body>
</html>

